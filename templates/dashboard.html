<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n-title="header_title">AI-POWERED DETECTION OF DISEASE IN PECHAY LEAVES</title>
  <script src="{{ url_for('static', filename='js/language.js') }}"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f8f4; }
    .sidebar { 
      position: fixed; 
      left: 0; 
      top: 0; 
      width: 220px; 
      height: 100%; 
      background: linear-gradient(135deg, #052e16, #064e3b, #022c22);
      background: 
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.15), transparent 60%),
        radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.2), transparent 55%),
        linear-gradient(135deg, #052e16, #064e3b, #022c22);
      color: #f0fff4; 
      padding-top: 20px; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar h2 { 
      text-align: center; 
      margin-bottom: 30px; 
      font-size: 20px; 
      color: #f0fff4;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .sidebar .logo {
      display: block;
      width: 80%;
      max-width: 150px;
      height: auto;
      margin: 0 auto 30px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    .sidebar a { 
      display: block; 
      color: #f0fff4; 
      padding: 12px 20px; 
      text-decoration: none; 
      font-size: 16px; 
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 5px 10px;
    }
    .sidebar a:hover { 
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding-left: 25px; 
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .sidebar a.active { 
      background: rgba(34, 197, 94, 0.25);
      backdrop-filter: blur(10px);
      color: #22c55e;
      font-weight: bold;
      border-left: 3px solid #22c55e;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
    }
    .main { margin-left: 220px; }
    .header { 
      background: linear-gradient(135deg, rgba(5, 46, 22, 0.9), rgba(6, 78, 59, 0.9));
      backdrop-filter: blur(10px);
      color: #f0fff4; 
      padding: 15px 25px; 
      font-size: 20px; 
      font-weight: bold; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .content { padding: 30px; display: flex; justify-content: center; align-items: center; min-height: 70vh; }
    .card { 
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 30px; 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      width: 100%; 
      text-align: left;
      margin: 15px auto;
    }
    .card.full-width {
      max-width: 1200px;
    }
    h1 { 
      color: #052e16; 
      margin-bottom: 15px; 
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(255,255,255,0.5);
    }
    p { 
      color: #052e16; 
      margin-bottom: 25px; 
      font-weight: 500;
      opacity: 0.9;
    }
    input[type="file"] { margin: 15px 0; padding: 10px; border: 2px solid #2e7d32; border-radius: 10px; cursor: pointer; width: 100%; }
    button { background: #2e7d32; color: white; padding: 14px 28px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    button:hover { background: #1b5e20; transform: scale(1.05); }
    img.preview { max-width: 100%; border-radius: 12px; margin-top: 20px; display: none; }
    footer { text-align: center; margin: 30px 0 0; padding: 15px; background: #f1f1f1; font-size: 14px; color: #777; }
    .status-message { 
      padding: 12px 18px; 
      margin: 10px 0; 
      border-radius: 12px; 
      background: rgba(34, 197, 94, 0.25);
      backdrop-filter: blur(10px);
      color: #14532d; 
      border: 1px solid rgba(34, 197, 94, 0.4);
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }
    .error-message { 
      background: rgba(220, 53, 69, 0.25);
      backdrop-filter: blur(10px);
      color: #991b1b; 
      border: 1px solid rgba(220, 53, 69, 0.4);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
    }
    .delete-result-btn {
      position: absolute !important;
      top: 10px !important;
      right: 10px !important;
      background: #dc3545 !important;
      color: white !important;
      border: 2px solid white !important;
      border-radius: 50% !important;
      width: 40px !important;
      height: 40px !important;
      cursor: pointer !important;
      font-size: 18px !important;
      font-weight: bold !important;
      z-index: 9999 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      line-height: 1 !important;
      visibility: visible !important;
      opacity: 1 !important;
      box-shadow: 0 3px 10px rgba(220, 53, 69, 0.6) !important;
      transition: all 0.3s ease !important;
    }
    .delete-result-btn:hover {
      background: #c82333 !important;
      transform: scale(1.15) !important;
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.8) !important;
    }
    .delete-result-btn:active {
      transform: scale(0.9) !important;
    }
    /* Ensure button is never hidden */
    .result-card .delete-result-btn {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    .result-card { 
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 4px solid #2e7d32;
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      background: rgba(255, 255, 255, 0.3);
    }
    .scanning-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .scanning-box {
      background: #020617;
      padding: 24px 28px;
      border-radius: 18px;
      width: 320px;
      max-width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      color: #e5e7eb;
      text-align: center;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }
    .scanning-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 1.05rem;
      color: #bbf7d0;
    }
    .scanning-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid rgba(34, 197, 94, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      animation: scanning-pulse 1.2s infinite ease-in-out;
      background: radial-gradient(circle at 30% 30%, rgba(34, 197, 94, 0.4), transparent);
    }
    .scanning-text {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .scanning-bar {
      position: relative;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.4), 0 8px 20px rgba(34, 197, 94, 0.35);
      margin-bottom: 10px;
    }
    .scanning-bar-track {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), rgba(21, 128, 61, 0.5), rgba(15, 23, 42, 0.9));
      opacity: 0.7;
    }
    .scanning-bar-fill {
      position: absolute;
      top: 0;
      left: -40%;
      width: 40%;
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.9);
      animation: scanning-move 1s infinite ease-in-out;
    }
    .scanning-progress-text {
      font-size: 0.8rem;
      color: #6ee7b7;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    @keyframes scanning-move {
      0% { left: -40%; }
      50% { left: 60%; }
      100% { left: 100%; }
    }
    @keyframes scanning-pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.8); }
      70% { transform: scale(1.12); box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { 
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(15px) saturate(180%);
      -webkit-backdrop-filter: blur(15px) saturate(180%);
      padding: 25px; 
      border-radius: 16px; 
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      text-align: center; 
      transition: all 0.3s ease;
    }
    .stat-card.clickable { cursor: pointer; }
    .stat-card.clickable:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 12px 32px rgba(34, 197, 94, 0.2);
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.5);
    }
    .stat-number { 
      font-size: 2.5em; 
      font-weight: bold; 
      color: #052e16;
      text-shadow: 0 2px 4px rgba(255,255,255,0.3);
    }
    .stat-label { 
      color: #052e16; 
      margin-top: 8px; 
      font-weight: 600;
      opacity: 0.8;
    }
    .filter-badge { 
      display: inline-block; 
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      color: #052e16; 
      padding: 8px 18px; 
      border-radius: 20px; 
      margin: 10px 5px; 
      font-size: 0.9rem; 
      border: 1px solid rgba(34, 197, 94, 0.4);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
      font-weight: 600;
    }
    .filter-badge .clear-filter { 
      margin-left: 10px; 
      cursor: pointer; 
      font-weight: bold; 
      padding: 2px 8px;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .filter-badge .clear-filter:hover { 
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    .date-filters {
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      margin: 15px 0; 
      padding: 15px; 
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px; 
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .date-filter-btn {
      padding: 10px 18px; 
      border: 1px solid rgba(34, 197, 94, 0.4); 
      border-radius: 10px; 
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      color: #052e16; 
      cursor: pointer; 
      font-size: 0.9rem; 
      font-weight: 600; 
      transition: all 0.3s; 
      text-decoration: none; 
      display: inline-block;
    }
    .date-filter-btn:hover {
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      color: #14532d; 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      border-color: rgba(34, 197, 94, 0.6);
    }
    .date-filter-btn.active {
      background: rgba(34, 197, 94, 0.4);
      backdrop-filter: blur(10px);
      color: #052e16; 
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    .delete-btn { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    .delete-btn:hover { background: #c82333; transform: scale(1.05); }
    .result-actions { margin-top: 15px; }
    .recommendations {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 4px solid #28a745; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .recommendations.diseased { border-left-color: #dc3545; }
    .recommendations h4 { color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; }
    .recommendations.diseased h4 { color: #991b1b; }
    .recommendations ul { margin: 10px 0; padding-left: 20px; }
    .recommendations li { margin: 8px 0; color: #052e16; font-weight: 500; }
    .recommendations .action { 
      background: rgba(34, 197, 94, 0.2);
      backdrop-filter: blur(10px);
      padding: 12px; 
      border-radius: 10px; 
      margin-top: 15px; 
      font-weight: 600; 
      color: #14532d; 
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .recommendations.diseased .action { 
      background: rgba(220, 53, 69, 0.2);
      backdrop-filter: blur(10px);
      color: #991b1b; 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    .recommendations.urgent { border-left-color: #ff0000; border-left-width: 6px; }
    .recommendations.urgent h4 { color: #991b1b; font-weight: bold; }
    .result-card.healthy { border-left-color: #28a745; }
    .result-card.diseased { border-left-color: #dc3545; }
    .status-healthy { color: #28a745; }
    .status-diseased { color: #dc3545; }
    .disease-name { color: #dc3545; }
    .upload-detection-card {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      border-radius: 20px;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 2px solid #f44336;
    }
    .upload-detection-card.healthy {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-color: #4caf50;
    }
    .upload-detection-header {
      display: flex;
      align-items: center;
      margin-bottom: 25px;
    }
    .upload-detection-icon {
      font-size: 3rem;
      margin-right: 15px;
    }
    .upload-detection-title {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }
    .upload-detection-title.title-healthy { color: #2e7d32; }
    .upload-detection-title.title-diseased { color: #c62828; }
    .upload-detection-subtitle {
      margin: 5px 0 0 0;
      color: #666;
      font-size: 0.95rem;
    }
    .upload-detection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    .upload-detection-card-item {
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.3s;
    }
    .upload-detection-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .upload-detection-status {
      font-size: 2rem;
      font-weight: bold;
    }
    .upload-detection-status-text {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #999;
    }
    .upload-detection-disease {
      font-size: 1.5rem;
      font-weight: bold;
      color: #c62828;
      word-wrap: break-word;
    }
    .upload-detection-confidence {
      font-size: 2rem;
      font-weight: bold;
      color: #2e7d32;
    }
    .upload-detection-bar {
      margin-top: 8px;
      width: 100%;
      background: #e0e0e0;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
    }
    .upload-detection-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #66bb6a);
      border-radius: 10px;
      transition: width 0.5s;
    }
    .upload-detection-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      border: 3px solid #f44336;
    }
    .upload-detection-image.image-healthy { border-color: #4caf50; }
    .camera-section {
      background: #fff !important;
      padding: 15px !important;
      border-radius: 12px !important;
      border: 3px solid #2e7d32 !important;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2) !important;
      display: block !important;
      visibility: visible !important;
      margin: 15px auto !important;
      max-width: 1200px !important;
      width: 95% !important;
    }
    .camera-section h2 {
      color: #2e7d32;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
    .camera-controls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .camera-controls input {
      flex: 2;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #2e7d32;
      border-radius: 8px;
      font-size: 1rem;
    }
    .camera-controls button {
      padding: 12px 20px;
      margin: 0;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .text-healthy { color: #2e7d32; font-size: 0.8rem; font-weight: bold; }
    .text-diseased { color: #dc3545; font-size: 0.8rem; font-weight: bold; }
    .camera-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .stream-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .stream-status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .stream-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #cameraViewContainer {
      position: relative;
      margin-top: 15px;
      background: #000;
      border-radius: 10px;
      min-height: 200px;
      max-height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2e7d32;
      overflow: hidden;
      width: 100%;
    }
    #cameraStream {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border-radius: 8px;
      object-fit: contain;
    }
    .content {
      padding: 20px;
      display: block;
      min-height: auto;
    }
    .card.upload-page {
      max-width: 1200px;
      text-align: left;
      margin: 15px auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    .settings-card {
      animation: fadeIn 0.5s ease;
    }
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .main {
        margin-left: 0;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Pechay System Logo" class="logo">
    <a href="{{ url_for('dashboard', page='dashboard') }}" class="{{ 'active' if page=='dashboard' else '' }}" data-i18n="dashboard">üìä Dashboard</a>
    <a href="{{ url_for('dashboard', page='upload') }}" class="{{ 'active' if page=='upload' else '' }}" data-i18n="scan_leaf">üì∏ Scan Leaf</a>
    <a href="{{ url_for('dashboard', page='results') }}" class="{{ 'active' if page=='results' else '' }}" data-i18n="results">üìù Results</a>
    <a href="{{ url_for('dashboard', page='analytics') }}" class="{{ 'active' if page=='analytics' else '' }}" data-i18n="analytics">üìà Analytics</a>
    <a href="{{ url_for('dashboard', page='settings') }}" class="{{ 'active' if page=='settings' else '' }}" data-i18n="settings">‚öôÔ∏è Settings</a>
  </div>

  <div class="main">
    <div class="header" data-i18n="header_title">AI-POWERED DETECTION OF DISEASE IN PECHAY LEAVES</div>
    <div class="scanning-overlay" id="scanningOverlay">
      <div class="scanning-box">
        <div class="scanning-header">
          <div class="scanning-icon">üì°</div>
          <div data-i18n="scanning_leaf">Scanning Leaf</div>
        </div>
        <div class="scanning-text" data-i18n="analyzing_image">
          Analyzing image to detect pechay leaf condition. Please wait a moment.
        </div>
        <div class="scanning-bar">
          <div class="scanning-bar-track"></div>
          <div class="scanning-bar-fill"></div>
        </div>
        <div class="scanning-progress-text" data-i18n="scanning_in_progress">
          Scanning in progress
        </div>
      </div>
    </div>
    <div class="content">
      {% if page == 'dashboard' %}
      <div class="card full-width">
        <h1 data-i18n="dashboard_overview">üìä Dashboard Overview</h1>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number">{{ dashboard_stats.total_scans }}</div><div class="stat-label" data-i18n="total_scans">Total Scans</div></div>
          <div class="stat-card clickable" data-href="{{ url_for('dashboard', page='results', filter='Healthy') }}" onclick="window.location.href=this.dataset.href" title="Click to view Healthy leaves">
            <div class="stat-number">üìÅ {{ dashboard_stats.healthy_leaves }}</div>
            <div class="stat-label" data-i18n="healthy_leaves">Healthy Leaves</div>
          </div>
          <div class="stat-card clickable" data-href="{{ url_for('dashboard', page='results', filter='Diseased') }}" onclick="window.location.href=this.dataset.href" title="Click to view Diseased leaves">
            <div class="stat-number">üìÅ {{ dashboard_stats.diseased_leaves }}</div>
            <div class="stat-label" data-i18n="diseased_leaves">Diseased Leaves</div>
          </div>
          <div class="stat-card"><div class="stat-number">{{ dashboard_stats.success_rate }}%</div><div class="stat-label" data-i18n="success_rate">Success Rate</div></div>
        </div>
        
        {% if dashboard_stats.total_scans == 0 %}
        <div class="status-message" style="background: rgba(34, 197, 94, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(34, 197, 94, 0.4); padding: 20px; border-radius: 12px;">
          <h3 style="color: #052e16; margin-top: 0;" data-i18n="welcome_message">üå± Welcome to Pechay Detection System!</h3>
          <p style="color: #052e16; margin-bottom: 0;" data-i18n="no_scans_message">No scans yet. Upload your first pechay leaf image to get started with detection.</p>
        </div>
        {% else %}
        <div class="status-message" style="background: rgba(34, 197, 94, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(34, 197, 94, 0.4); padding: 20px; border-radius: 12px;">
          <h3 style="color: #052e16; margin-top: 0;" data-i18n="recent_activity">üìà Recent Activity</h3>
          <p style="color: #052e16; margin-bottom: 5px;"><span data-i18n="processed_images">You have processed</span> <strong>{{ dashboard_stats.total_scans }}</strong> <span data-i18n="leaf_images">leaf images.</span></p>
          <p style="color: #052e16; margin-bottom: 0;"><strong data-i18n="health_distribution">Health Distribution:</strong> {{ "%.0f"|format((dashboard_stats.healthy_leaves / dashboard_stats.total_scans) * 100) }}% <span data-i18n="healthy_percent">healthy</span>, {{ "%.0f"|format((dashboard_stats.diseased_leaves / dashboard_stats.total_scans) * 100) }}% <span data-i18n="diseased_percent">diseased</span></p>
        </div>
        {% endif %}
        
        <div style="margin-top: 25px;">
          <a href="{{ url_for('dataset_manager') }}" style="display:inline-block;background:#1b5e20;color:white;padding:16px 32px;text-decoration:none;border-radius:12px;margin-right:15px;font-size:1.1rem;font-weight:bold;box-shadow:0 4px 12px rgba(27,94,32,0.3);" data-i18n="create_dataset">
            ‚ûï Create Petchay Dataset
          </a>
          <a href="{{ url_for('dashboard', page='upload') }}" style="display:inline-block;background:#2e7d32;color:white;padding:12px 24px;text-decoration:none;border-radius:8px;margin-right:15px;" data-i18n="upload_new_image">üì∑ Upload New Image</a>
          <a href="{{ url_for('dashboard', page='results') }}" style="display:inline-block;background:#388e3c;color:white;padding:12px 24px;text-decoration:none;border-radius:8px;" data-i18n="view_results">üìù View Results</a>
        </div>
      </div>
      {% elif page == 'analytics' %}
      <div class="card full-width">
        <h1 data-i18n="analytics_reports">üìà Analytics & Reports</h1>
        
        {% if analytics_data %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
           <!-- Charts containers -->
           <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;" data-i18n="last_7_days_activity">Last 7 Days Activity</h3>
             <canvas id="dailyChart" style="max-height: 200px;"></canvas>
           </div>
           <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;" data-i18n="health_distribution_chart">Health Distribution</h3>
             <div style="height: 200px; display: flex; justify-content: center;">
                <canvas id="pieChart"></canvas>
             </div>
           </div>
        </div>

        <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin-bottom: 30px;">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;" data-i18n="confidence_distribution">Confidence Level Distribution</h3>
             <canvas id="confidenceChart" style="max-height: 200px;"></canvas>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3 style="color: #2e7d32; text-align: center;" data-i18n="generate_report">üìÑ Generate Report</h3>
            <p style="text-align: center;" data-i18n="customize_download">Customize and download a printable report of your detection history.</p>
            
            <form action="{{ url_for('report') }}" method="GET" style="max-width: 600px; margin: 0 auto; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 25px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #052e16;" data-i18n="condition">Condition:</label>
                    <select name="condition" style="width: 100%; padding: 12px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16; font-weight: 500;">
                        <option value="All" data-i18n="all_conditions">All Conditions</option>
                        <option value="Healthy" data-i18n="healthy_only_option">Healthy Only</option>
                        <option value="Diseased" data-i18n="diseased_only_option">Diseased Only</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #052e16;" data-i18n="time_range">Time Range:</label>
                    <select name="range" id="reportRange" onchange="toggleCustomDates()" style="width: 100%; padding: 12px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16; font-weight: 500;">
                        <option value="all" data-i18n="all_time_option">All Time</option>
                        <option value="day" data-i18n="last_24_hours_option">Last 24 Hours</option>
                        <option value="week" data-i18n="last_7_days_option">Last 7 Days</option>
                        <option value="month" data-i18n="last_30_days">Last 30 Days</option>
                        <option value="custom" data-i18n="custom_range">Custom Range</option>
                    </select>
                </div>
                
                <div id="customDates" style="display: none; margin-bottom: 15px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5);">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #052e16; font-weight: 600;" data-i18n="start_date">Start Date:</label>
                        <input type="date" name="start_date" style="width: 100%; padding: 10px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #052e16; font-weight: 600;" data-i18n="end_date">End Date:</label>
                        <input type="date" name="end_date" style="width: 100%; padding: 10px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16;">
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button type="submit" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #052e16; padding: 14px 28px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s;" data-i18n="generate_view_report">
                        <span>üñ®Ô∏è</span> Generate & View Report
                    </button>
                </div>
            </form>
            
            <script>
                function toggleCustomDates() {
                    var range = document.getElementById('reportRange').value;
                    var customDates = document.getElementById('customDates');
                    if (range === 'custom') {
                        customDates.style.display = 'block';
                    } else {
                        customDates.style.display = 'none';
                    }
                }
            </script>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <!-- Data for charts -->
        <script type="application/json" id="daily-labels">{{ analytics_data.daily_labels | tojson | safe }}</script>
        <script type="application/json" id="daily-values">{{ analytics_data.daily_values | tojson | safe }}</script>
        <script type="application/json" id="confidence-labels">{{ analytics_data.confidence_labels | tojson | safe }}</script>
        <script type="application/json" id="confidence-values">{{ analytics_data.confidence_values | tojson | safe }}</script>
        
        <script>
            // Parse data from hidden script tags to avoid linter errors with Jinja syntax
            const dailyLabels = JSON.parse(document.getElementById('daily-labels').textContent);
            const dailyValues = JSON.parse(document.getElementById('daily-values').textContent);
            const confidenceLabels = JSON.parse(document.getElementById('confidence-labels').textContent);
            const confidenceValues = JSON.parse(document.getElementById('confidence-values').textContent);
            const healthyCount = Number('{{ analytics_data.healthy_count }}');
            const diseasedCount = Number('{{ analytics_data.diseased_count }}');

            // Daily Chart
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Scans',
                        data: dailyValues,
                        backgroundColor: '#2e7d32',
                        borderRadius: 4
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });

            // Pie Chart
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Healthy', 'Diseased'],
                    datasets: [{
                        data: [healthyCount, diseasedCount],
                        backgroundColor: ['#4caf50', '#f44336']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Confidence Chart
            new Chart(document.getElementById('confidenceChart'), {
                type: 'bar',
                data: {
                    labels: confidenceLabels,
                    datasets: [{
                        label: 'Count',
                        data: confidenceValues,
                        backgroundColor: '#1976d2',
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        </script>
        {% else %}
        <div class="status-message error-message" style="background: rgba(220, 53, 69, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(220, 53, 69, 0.4); color: #991b1b; font-weight: 600;" data-i18n="failed_load_analytics">
            Failed to load analytics data. Please try again.
        </div>
        {% endif %}
      </div>
      {% elif page == 'upload' %}
      <!-- ESP32-CAM Live Stream Section - MUST BE VISIBLE -->
      <div class="camera-section" id="esp32CameraSection">
        <h2 data-i18n="esp32_cam_live_view">üìπ ESP32-CAM Live View</h2>
        <div id="streamStatus" class="stream-status" data-i18n="enter_ip_address">
          Enter ESP32-CAM IP address and click "Start Stream" or "Start Polling"
        </div>
        
        <div class="camera-controls" style="margin-bottom: 20px;">
          <input type="text" id="cameraIP" placeholder="" data-i18n-placeholder="camera_ip_placeholder" value="" onkeypress="if(event.key==='Enter') startStream()">
          <button type="button" onclick="startStream()" style="background: #2e7d32;" data-i18n="start_stream">‚ñ∂Ô∏è Start Stream</button>
          <button type="button" onclick="stopStream()" style="background: #dc3545;" data-i18n="stop">‚èπÔ∏è Stop</button>
        </div>

        <div class="live-view-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <!-- Left Column: Camera View -->
            <div class="camera-view-column">
                <div id="cameraViewContainer" style="position: relative; width: 100%; min-height: 480px; background: #000; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid #2e7d32;">
                    <img id="cameraStream" src="" alt="Camera stream" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;" crossorigin="anonymous">
                    <iframe id="cameraStreamFrame" src="" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
                    <canvas id="overlayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none;"></canvas>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                    
                    <div id="streamPlaceholder" style="color: #999; text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üì∑</div>
                        <div style="font-size: 1.3rem; margin-bottom: 15px; color: #fff;" data-i18n="camera_live_view">Camera Live View</div>
                        <div style="color: #aaa; margin-bottom: 10px;" data-i18n="enter_ip_above">Enter ESP32-CAM IP address above</div>
                        <small style="color: #888;" data-i18n="click_start">Click "Start Polling" or "Start Stream" to begin</small>
                    </div>
                </div>

            </div>

            <!-- Right Column: Controls & Info -->
            <div class="controls-column" style="background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #ddd; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content;">
                
                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Confidence Threshold: <span id="confValue" style="color: #6f42c1;">30%</span>
                    </label>
                    <input type="range" id="confThreshold" min="0" max="100" value="30" style="width: 100%; accent-color: #6f42c1; cursor: pointer;" oninput="document.getElementById('confValue').textContent = this.value + '%'">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-top: 4px;">
                        <span>0%</span><span>100%</span>
                    </div>
                </div>

                <div class="control-group" style="margin-bottom: 20px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Overlap Threshold: <span id="overlapValue" style="color: #6f42c1;">50%</span>
                    </label>
                    <input type="range" id="overlapThreshold" min="0" max="100" value="50" style="width: 100%; accent-color: #6f42c1; cursor: pointer;" oninput="document.getElementById('overlapValue').textContent = this.value + '%'">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-top: 4px;">
                        <span>0%</span><span>100%</span>
                    </div>
                </div>

                 <div class="control-group" style="margin-bottom: 20px;">
                    <label style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600; color: #333;">
                        Opacity Threshold: <span id="opacityValue" style="color: #6f42c1;">75%</span>
                    </label>
                    <input type="range" id="opacityThreshold" min="0" max="100" value="75" style="width: 100%; accent-color: #6f42c1; cursor: pointer;" oninput="document.getElementById('opacityValue').textContent = this.value + '%'">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-top: 4px;">
                        <span>0%</span><span>100%</span>
                    </div>
                </div>

                <div class="control-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Label Display Mode:</label>
                    <select id="labelMode" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer;">
                        <option value="conf">Draw Confidence</option>
                        <option value="label">Label Only</option>
                        <option value="none">None</option>
                    </select>
                </div>

                <!-- JSON Output -->
                <div class="json-output">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 600; color: #333;">Detection Output:</label>
                        <button onclick="copyJson()" style="background: none; border: none; color: #6f42c1; cursor: pointer; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 4px;">
                            Copy üìã
                        </button>
                    </div>
                    <pre id="jsonOutput" style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #eee; height: 200px; overflow-y: auto; font-size: 0.8rem; color: #333; font-family: monospace; white-space: pre-wrap; margin: 0;">{
  "predictions": []
}</pre>
                </div>
            </div>
        </div>
      </div>
      
      <div class="card upload-page" style="margin-top: 30px;">
        <h1 data-i18n="scan_pechay_leaf">üì∏ Scan Petchay Leaf</h1>
        <p data-i18n="upload_description">Upload a pechay leaf image to detect disease condition.</p>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for m in messages %}<div class="status-message">{{ m }}</div>{% endfor %}
          {% endif %}
        {% endwith %}
        {% if upload_status %}
        <div class="status-message {{ 'error-message' if 'Error' in upload_status else '' }}">{{ upload_status }}</div>
        {% endif %}
        {% if detection_result and detection_result.get('disease_name') and detection_result.get('confidence', 0) >= 0 %}
        <div class="result-card upload-detection-card {{ 'healthy' if detection_result.condition == 'Healthy' else 'diseased' }}">
          <div class="upload-detection-header">
            <div class="upload-detection-icon">
              {% if detection_result.condition == 'Healthy' %}üåø{% else %}‚ö†Ô∏è{% endif %}
            </div>
            <div>
              <h3 class="upload-detection-title {{ 'title-healthy' if detection_result.condition == 'Healthy' else 'title-diseased' }}" data-i18n="detection_result">
                Detection Result
              </h3>
              <p class="upload-detection-subtitle" data-i18n="leaf_condition_analysis">Leaf condition analysis complete</p>
            </div>
          </div>
          
          <div class="upload-detection-grid">
            <div class="upload-detection-card-item" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              <div class="upload-detection-label" data-i18n="status">Status</div>
              <div class="upload-detection-status {{ 'status-healthy' if detection_result.condition == 'Healthy' else 'status-diseased' }}">
                {% if detection_result.disease_name == 'Not Pechay Leaf' %}
                <span data-i18n="not_pechay_leaf">Not Pechay Leaf</span>
                {% else %}
                {{ detection_result.condition }}
                {% endif %}
              </div>
              <div class="upload-detection-status-text">
                {% if detection_result.disease_name == 'Not Pechay Leaf' %}
                <span data-i18n="uploaded_not_pechay">Uploaded image is not a pechay leaf</span>
                {% elif detection_result.condition == 'Healthy' %}
                <span data-i18n="leaf_is_healthy">Leaf is healthy</span>
                {% else %}
                <span data-i18n="disease_detected">Disease detected</span>
                {% endif %}
              </div>
            </div>
            
            {% if detection_result.disease_name %}
            <div class="upload-detection-card-item" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              <div class="upload-detection-label" data-i18n="disease">Disease</div>
              <div class="upload-detection-disease">
                {{ detection_result.disease_name }}
              </div>
            </div>
            {% endif %}
            
            <div class="upload-detection-card-item" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
              <div class="upload-detection-label" data-i18n="confidence">Confidence</div>
              <div class="upload-detection-confidence">
                {{ "%.1f"|format(detection_result.confidence) }}%
              </div>
              <div class="upload-detection-bar">
                <div class="upload-detection-bar-fill" data-confidence="{{ detection_result.confidence }}"></div>
              </div>
            </div>
          </div>
          
          {% if detection_result.treatment and not detection_result.treatment.startswith('Detection service unavailable') and not detection_result.treatment.startswith('Could not parse') %}
          <div style="background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); padding: 25px; border-radius: 15px; margin-top: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 5px solid #fbc02d;">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <div style="font-size: 2rem; margin-right: 12px;">üíä</div>
              <h4 style="margin: 0; font-size: 1.3rem; color: #f57f17; font-weight: 700;" data-i18n="treatment">Treatment</h4>
            </div>
            <div style="font-size: 1rem; color: #5d4037; line-height: 1.8; white-space: pre-wrap; background: rgba(255,255,255,0.6); padding: 20px; border-radius: 10px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
              {{ detection_result.treatment }}
            </div>
          </div>
          {% endif %}
          
          {% if detection_result.image_path %}
          <div style="margin-top: 25px; text-align: center;">
            <img src="/{{ detection_result.image_path }}" class="upload-detection-image {{ 'image-healthy' if detection_result.condition == 'Healthy' else 'image-diseased' }}" alt="Scanned Leaf Image" />
            <p style="margin-top: 10px; color: #666; font-size: 0.9rem;" data-i18n="scanned_image">Scanned Image</p>
          </div>
          {% endif %}
        </div>
        
        {% endif %}
        <form method="POST" enctype="multipart/form-data">
          <input type="file" name="leafImage" accept="image/*" required style="margin-bottom: 15px;">
          <br>
          <button type="submit" style="background: #2e7d32; color: white; padding: 16px 40px; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(46,125,50,0.3);" data-i18n="scan_pechay_leaf">
            üì∏ Scan Petchay Leaf
          </button>
        </form>
      </div>
      {% elif page == 'results' %}
      <div class="card" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
        <h1 style="color: #052e16; text-shadow: 0 2px 4px rgba(255,255,255,0.5);" data-i18n="detection_results">üìù Detection Results</h1>
        
        <div class="date-filters">
          <span style="color: #555; font-weight: 600; margin-right: 10px;" data-i18n="filter_by_time">üìÖ Filter by time range:</span>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='') }}" 
             class="date-filter-btn {{ 'active' if not filter_days else '' }}" data-i18n="all_time">
            All Time
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='1') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '1' else '' }}" data-i18n="last_24_hours">
            Last 24 Hours
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='7') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '7' else '' }}" data-i18n="last_7_days">
            Last 7 Days
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='21') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '21' else '' }}" data-i18n="last_21_days">
            Last 21 Days
          </a>
        </div>
        
        <div style="margin-top: 10px; margin-bottom: 10px;">
          <span style="color: #555; font-weight: 600; margin-right: 10px;" data-i18n="status_filter">Status:</span>
          <select id="resultStatusFilter" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
            <option value="all" data-i18n="all">All</option>
            <option value="healthy" data-i18n="healthy_only">Healthy Only</option>
            <option value="diseased" data-i18n="diseased_only">Diseased Only</option>
            <option value="not-pechay" data-i18n="not_pechay_only">Not Pechay Only</option>
          </select>
        </div>
        
        {% if filter_condition %}
        <div class="filter-badge">
          <span data-i18n="showing_filter">Showing:</span> <strong>{{ filter_condition }}</strong> <span data-i18n="leaves_only">leaves only</span>
          <span class="clear-filter" data-href="{{ url_for('dashboard', page='results', days=filter_days) }}" onclick="window.location.href=this.dataset.href" data-i18n="clear_filter">‚úï Clear Filter</span>
        </div>
        {% endif %}
        
        {% if filter_days and date_range_text %}
        <div class="filter-badge" style="background: #17a2b8;">
          Showing results from: <strong>{{ date_range_text }}</strong>
          <span class="clear-filter" data-href="{{ url_for('dashboard', page='results', filter=filter_condition) }}" onclick="window.location.href=this.dataset.href">‚úï Clear</span>
        </div>
        {% endif %}
        
        <p style="color: #052e16; font-weight: 500; margin-bottom: 20px;" data-i18n="recent_detection_results">Recent leaf detection results and analysis.</p>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for m in messages %}<div class="status-message">{{ m }}</div>{% endfor %}
          {% endif %}
        {% endwith %}
        {% if results|length == 0 %}
        <div class="status-message">
          {% if filter_condition %}
          <span data-i18n="no_filtered_results">No</span> {{ filter_condition.lower() }} <span data-i18n="leaves_found">leaves found. Try removing the filter or upload new images.</span>
          {% else %}
          <span data-i18n="no_results_found">No detection results found. Upload some images first!</span>
          {% endif %}
        </div>
          {% else %}
          {% for r in results %}
          <div class="result-card {{ 'healthy' if r.condition == 'Healthy' else 'diseased' }}" style="border-left: 5px solid; position: relative;" data-pechay-status="{% if r.disease_name in ['Not Pechay Leaf', 'Not Pechay', 'Detection Failed'] %}not-pechay{% else %}pechay{% endif %}" data-condition="{{ 'healthy' if r.condition == 'Healthy' else 'diseased' }}" data-detection-id="{{ r.id if r.id else '' }}">
            <!-- Delete Button - Always Visible -->
            <button class="delete-result-btn" onclick="deleteDetection('{{ r.id if r.id else '' }}', '{{ r.filename }}')" title="Delete this result" data-i18n="delete" aria-label="Delete" data-detection-id="{{ r.id if r.id else '' }}" style="position: absolute !important; top: 10px !important; right: 10px !important; background: #dc3545 !important; color: white !important; border: 2px solid white !important; border-radius: 50% !important; width: 40px !important; height: 40px !important; cursor: pointer !important; font-size: 18px !important; z-index: 9999 !important; display: flex !important; align-items: center !important; justify-content: center !important; padding: 0 !important; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.6) !important; visibility: visible !important; opacity: 1 !important; line-height: 1 !important;">‚úï</button>
            <h4 class="{{ 'status-healthy' if r.condition == 'Healthy' else 'status-diseased' }}" style="margin-top: 0;">{{ r.filename }}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;">
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;" data-i18n="status">Status</div>
                <div class="{{ 'status-healthy' if r.condition == 'Healthy' else 'status-diseased' }}" style="font-size: 1.2rem; font-weight: bold;">
                  {% if r.disease_name in ['Not Pechay Leaf', 'Not Pechay', 'Detection Failed'] %}
                  Not Pechay Leaf
                  {% else %}
                  {{ r.condition }}
                  {% endif %}
                </div>
              </div>
              {% if r.disease_name %}
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;" data-i18n="disease">Disease</div>
                <div class="disease-name" style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">
                  {% if r.disease_name in ['Detection Failed', 'Not Pechay'] %}
                  Not Pechay Leaf
                  {% else %}
                  {{ r.disease_name }}
                  {% endif %}
                </div>
              </div>
              {% endif %}
              {% if r.treatment %}
              <div style="background: linear-gradient(135deg, rgba(255, 243, 205, 0.8) 0%, rgba(255, 234, 167, 0.8) 100%); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1); grid-column: 1 / -1; margin-top: 10px; border-left: 4px solid #ffc107;">
                <div style="font-size: 0.8rem; color: #856404; margin-bottom: 8px; font-weight: 600; opacity: 0.9;">
                  <i class="fas fa-prescription-bottle-alt"></i> Treatment
                </div>
                <div style="font-size: 0.95rem; color: #856404; line-height: 1.6; white-space: pre-wrap;">
                  {{ r.treatment }}
                </div>
              </div>
              {% endif %}
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;" data-i18n="confidence">Confidence</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #14532d;">
                  {{ "%.0f"|format(r.confidence) }}%
                </div>
              </div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin: 10px 0;"><strong data-i18n="date">Date:</strong> {{ r.timestamp }}</p>
            {% if r.filename %}
            <img src="{{ url_for('uploaded_file', filename=r.filename) }}" 
                 alt="{{ r.filename }}" 
                 style="max-width:200px;border-radius:8px;margin-top:10px;display:block;cursor:pointer;"
                 onclick="window.open(this.src, '_blank')"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22200%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2214%22%3EImage not found%3C/text%3E%3C/svg%3E'; this.style.border='2px dashed #ccc';" />
            {% else %}
            <p style="color:#999;font-style:italic;margin-top:10px;">No image available</p>
            {% endif %}
            
            {% if r.treatment %}
            <div style="background: linear-gradient(135deg, rgba(255, 243, 205, 0.9) 0%, rgba(255, 234, 167, 0.9) 100%); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 15px; border-left: 5px solid #ffc107;">
              <h4 style="color: #856404; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-prescription-bottle-alt"></i> <span data-i18n="treatment">Treatment</span> Information
              </h4>
              <div style="font-size: 0.95rem; color: #856404; line-height: 1.8; white-space: pre-wrap; background: rgba(255, 255, 255, 0.6); padding: 15px; border-radius: 8px;">
                {{ r.treatment }}
              </div>
            </div>
            {% endif %}
            
          </div>
          {% endfor %}
        {% endif %}
      </div>
      {% elif page == 'dataset' %}
      <div class="card upload-page">
        <h1>üìÇ Dataset Management</h1>
        <p>This feature has been disabled.</p>
      </div>
      {% elif page == 'settings' %}
      <div class="card upload-page" style="max-width: 900px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 40px;">
          <h1 style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;" data-i18n="settings">‚öôÔ∏è Settings</h1>
          <p style="color: #666; font-size: 1.1rem;">Manage your account preferences and settings</p>
        </div>
        
        {% if settings_message %}
        <div class="status-message {{ 'error-message' if 'Error' in settings_message else '' }}" style="margin-bottom: 30px; animation: slideDown 0.3s ease;">
          {{ settings_message }}
        </div>
        {% endif %}
        
        <!-- Language Settings Section -->
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 197, 253, 0.1) 100%); backdrop-filter: blur(20px); padding: 30px; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.2); margin-bottom: 30px; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(59, 130, 246, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(59, 130, 246, 0.1)'">
          <div style="display: flex; align-items: center; margin-bottom: 25px;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
              <span style="font-size: 1.5rem;">üåê</span>
            </div>
            <h2 style="color: #1e40af; margin: 0; font-size: 1.5rem; font-weight: 700;" data-i18n="language_settings">üåê Language Settings</h2>
          </div>
          
          <div style="margin-bottom: 0;">
            <label style="display: block; margin-bottom: 12px; color: #1e3a8a; font-weight: 600; font-size: 0.95rem;" data-i18n="select_language">Select Language:</label>
            <select id="languageSelect" style="width: 100%; padding: 16px 20px; border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; font-size: 1rem; cursor: pointer; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #1e40af; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.1);" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 4px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.boxShadow='0 4px 15px rgba(59, 130, 246, 0.1)'">
              <option value="en">üá∫üá∏ English</option>
              <option value="tl">üáµüá≠ Tagalog</option>
              <option value="war">üáµüá≠ Waray-Waray</option>
            </select>
          </div>
        </div>
        
        <!-- User Profile Section -->
        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%); backdrop-filter: blur(20px); padding: 35px; border-radius: 20px; border: 1px solid rgba(34, 197, 94, 0.2); margin-bottom: 30px; box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(34, 197, 94, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(34, 197, 94, 0.1)'">
          <div style="display: flex; align-items: center; margin-bottom: 30px;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);">
              <span style="font-size: 1.5rem;">üë§</span>
            </div>
            <h2 style="color: #14532d; margin: 0; font-size: 1.5rem; font-weight: 700;" data-i18n="profile_settings">üë§ Profile Settings</h2>
          </div>
          
          <form method="POST" action="{{ url_for('dashboard', page='settings') }}">
            <input type="hidden" name="action" value="update_profile">
            
            <div style="margin-bottom: 25px;">
              <label style="display: block; margin-bottom: 10px; color: #14532d; font-weight: 600; font-size: 0.95rem;" data-i18n="username">Username:</label>
              <div style="position: relative;">
                <input type="text" name="username" value="{{ current_user.username if current_user else session.user }}" 
                       style="width: 100%; padding: 16px 20px; border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #14532d; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.1);" 
                       required readonly>
                <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #22c55e; font-size: 1.2rem;">üîí</div>
              </div>
              <small style="color: #6b7280; font-size: 0.85rem; margin-top: 8px; display: block;" data-i18n="username_immutable">Username cannot be changed</small>
            </div>
            
            <div style="margin-bottom: 30px;">
              <label style="display: block; margin-bottom: 10px; color: #14532d; font-weight: 600; font-size: 0.95rem;" data-i18n="email">Email:</label>
              <input type="email" name="email" value="{{ current_user.email if current_user else '' }}" 
                     style="width: 100%; padding: 16px 20px; border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #14532d; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.1);" 
                     required
                     onfocus="this.style.borderColor='#22c55e'; this.style.boxShadow='0 0 0 4px rgba(34, 197, 94, 0.1)'"
                     onblur="this.style.borderColor='rgba(34, 197, 94, 0.3)'; this.style.boxShadow='0 4px 15px rgba(34, 197, 94, 0.1)'">
            </div>
            
            <button type="submit" style="width: 100%; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 16px 24px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px;" 
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(34, 197, 94, 0.4)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(34, 197, 94, 0.3)'"
                    data-i18n="update_profile">
              <span>üíæ</span> <span>Update Profile</span>
            </button>
          </form>
        </div>
        
        <!-- Logout Section -->
        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); backdrop-filter: blur(20px); padding: 35px; border-radius: 20px; border: 1px solid rgba(251, 191, 36, 0.2); margin-top: 30px; box-shadow: 0 8px 32px rgba(251, 191, 36, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;" 
             onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 40px rgba(251, 191, 36, 0.15)'" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(251, 191, 36, 0.1)'">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);">
              <span style="font-size: 1.5rem;">üö™</span>
            </div>
            <h2 style="color: #92400e; margin: 0; font-size: 1.5rem; font-weight: 700;" data-i18n="session_management">üö™ Session Management</h2>
          </div>
          
          <p style="color: #78350f; margin-bottom: 25px; font-size: 1rem; line-height: 1.6;" data-i18n="sign_out_desc">Sign out of your account. You can log back in anytime.</p>
          
          <a href="{{ url_for('logout') }}" 
             style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);" 
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.4)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(251, 191, 36, 0.3)'"
             data-i18n="logout">
            <span>üö™</span> <span>Logout</span>
          </a>
        </div>
      </div>
      {% endif %}
    </div>
    <footer>
      &copy; 2025 Pechay Detection System | Group 4 BSIT 4A
    </footer>
  </div>


  <script id="app-context" type="application/json">
    {
      "page": "{{ page }}"
    }
  </script>

  <script>
    // Delete detection function
    function deleteDetection(detectionId, filename) {
      if (!detectionId) {
        alert('Detection ID not found');
        return;
      }
      
      // Get translated confirmation message
      const confirmMsg = translate('delete_confirm') || `Are you sure you want to delete this detection result?\n\nFile: ${filename}\n\nThis action cannot be undone.`;
      const confirmed = confirm(confirmMsg.replace('{filename}', filename));
      
      if (!confirmed) {
        return;
      }
      
      // Show loading state
      const deleteBtn = event.target;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = translate('deleting') || '‚è≥ Deleting...';
      deleteBtn.style.opacity = '0.6';
      
      // Send delete request
      fetch('/api/delete_detection', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: detectionId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the card with animation
          const card = deleteBtn.closest('.result-card');
          if (card) {
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-100px)';
            
            setTimeout(() => {
              card.remove();
              
              // Check if no results left
              const remainingCards = document.querySelectorAll('.result-card');
              if (remainingCards.length === 0) {
                // Reload page to show "no results" message
                window.location.reload();
              }
            }, 300);
          }
          
          // Show success message
          const successMsg = document.createElement('div');
          successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; animation: slideIn 0.3s ease;';
          successMsg.textContent = translate('delete_success') || '‚úì Detection deleted successfully';
          document.body.appendChild(successMsg);
          
          setTimeout(() => {
            successMsg.style.opacity = '0';
            successMsg.style.transform = 'translateX(100px)';
            setTimeout(() => successMsg.remove(), 300);
          }, 3000);
        } else {
          // Show error message
          alert((translate('delete_error') || 'Error deleting detection: ') + (data.error || 'Unknown error'));
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = originalText;
          deleteBtn.style.opacity = '1';
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        alert(translate('delete_error') || 'Error deleting detection. Please try again.');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        deleteBtn.style.opacity = '1';
      });
    }
    
    window.addEventListener('DOMContentLoaded', function() {
      const bars = document.querySelectorAll('.upload-detection-bar-fill[data-confidence]');
      bars.forEach(function(bar) {
        const value = parseFloat(bar.getAttribute('data-confidence') || '0');
        let width = value;
        if (width < 0) width = 0;
        if (width > 100) width = 100;
        bar.style.width = width + '%';
      });
      const statusFilter = document.getElementById('resultStatusFilter');
      function applyResultFilters() {
        const filterValue = statusFilter ? statusFilter.value : 'all';
        const cards = document.querySelectorAll('.result-card');
        cards.forEach(function(card) {
          const status = card.getAttribute('data-pechay-status') || 'pechay';
          const condition = card.getAttribute('data-condition') || 'diseased';
          let show = true;
          if (filterValue === 'healthy') {
            show = condition === 'healthy' && status !== 'not-pechay';
          } else if (filterValue === 'diseased') {
            show = condition === 'diseased' && status !== 'not-pechay';
          } else if (filterValue === 'not-pechay') {
            show = status === 'not-pechay';
          }
          card.style.display = show ? '' : 'none';
        });
      }
      if (statusFilter) {
        statusFilter.addEventListener('change', applyResultFilters);
      }
      const scanningOverlay = document.getElementById('scanningOverlay');
      function showScanningOverlay() {
        if (scanningOverlay) {
          scanningOverlay.style.display = 'flex';
        }
      }
      try {
        const contextElement = document.getElementById('app-context');
        let currentPage = 'unknown';
        if (contextElement) {
          const context = JSON.parse(contextElement.textContent);
          currentPage = context.page;
        }
        if (currentPage === 'upload') {
          const uploadCard = document.querySelector('.card.upload-page');
          const uploadForm = uploadCard ? uploadCard.querySelector('form[method="POST"][enctype="multipart/form-data"]') : null;
          if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
              showScanningOverlay();
            });
          }
          const captureBtn = document.getElementById('captureBtn');
          if (captureBtn) {
            captureBtn.addEventListener('click', function() {
              showScanningOverlay();
            });
          }
        }
      } catch (e) {
        console.error('Scanning overlay init error:', e);
      }
    });

    let streamInterval = null;
    let autoDetectInterval = null;
    let cameraStreamImg = null;
    
    window.addEventListener('DOMContentLoaded', function() {
      let currentPage = 'unknown';
      try {
        const context = JSON.parse(document.getElementById('app-context').textContent);
        currentPage = context.page;
      } catch (e) {
        console.error('Failed to parse app context:', e);
      }

      if (currentPage === 'upload') {
        const cameraSection = document.getElementById('esp32CameraSection');
        const cameraIP = document.getElementById('cameraIP');
        
        console.log('=== Camera Section Debug ===');
        if (cameraSection) {
          console.log('‚úì Camera section found');
          cameraSection.style.display = 'block';
          cameraSection.style.visibility = 'visible';
        } else {
          console.error('‚úó Camera section NOT found!');
        }
        if (cameraIP) {
          console.log('‚úì Camera IP input found');
        } else {
          console.error('‚úó Camera IP input NOT found!');
        }
        console.log('===========================');
      }
    });
    
    function startStream() {
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) {
        alert('Camera IP input not found!');
        return;
      }
      // Clean up IP input (remove http://, https://, and trailing slashes)
      let ipValue = cameraIP.value.trim();
      ipValue = ipValue.replace(/^https?:\/\//, '').replace(/\/+$/, '');
      
      const statusDiv = document.getElementById('streamStatus');
      const streamImg = document.getElementById('cameraStream');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      stopStream();
      if (placeholder) placeholder.style.display = 'none';
      
      const streamUrl = 'http://' + ipValue + '/stream';
      streamImg.style.display = 'block';
      streamImg.style.width = '100%';
      streamImg.style.height = 'auto';
      // Enable CORS for canvas operations
      streamImg.crossOrigin = 'anonymous';
      cameraStreamImg = streamImg;
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Connecting to camera at ' + ipValue + '...';
      }
      
      const timestamp = new Date().getTime();
      streamImg.src = streamUrl + '?t=' + timestamp;
      
      streamImg.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Stream connected successfully! Auto-detection starting...';
        }
        if (captureBtn) captureBtn.disabled = false;
        if (placeholder) placeholder.style.display = 'none';
        
        // Start auto-detection immediately
        startAutoDetect();
      };
      
      streamImg.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Failed to connect to ' + streamUrl + '. Check IP address and ensure ESP32-CAM is streaming.';
        }
        console.error('Stream load error for:', streamUrl);
        streamImg.style.display = 'none';
        if (captureBtn) captureBtn.disabled = true;
        if (placeholder) placeholder.style.display = 'block';
      };
    }
    
    function startAutoDetect() {
      // Ensure stream is running
      // Note: We removed explicit startPolling call to avoid conflict with startStream
      // The processAutoDetect function handles both stream and polled images
      
      const statusDiv = document.getElementById('streamStatus');
      const overlayCanvas = document.getElementById('overlayCanvas');
      if (statusDiv) {
        statusDiv.textContent = 'ü§ñ Auto-Detection Active - Scanning...';
        statusDiv.className = 'stream-status connected';
      }
      if (overlayCanvas) {
        overlayCanvas.style.display = 'block';
      }
      
      // Stop existing auto-detect if any
      if (autoDetectInterval) clearInterval(autoDetectInterval);

      // Check every 1.5 seconds for near real-time feel
      autoDetectInterval = setInterval(processAutoDetect, 1500); 
    }

    function copyJson() {
      const jsonText = document.getElementById('jsonOutput').textContent;
      navigator.clipboard.writeText(jsonText).then(() => {
        const btn = document.querySelector('button[onclick="copyJson()"]');
        if(btn) {
           const originalText = btn.innerHTML;
           btn.innerHTML = 'Copied! ‚úÖ';
           setTimeout(() => btn.innerHTML = originalText, 2000);
        }
      });
    }

    // Intersection over Union (IoU) Calculation
    function calculateIoU(boxA, boxB) {
      // Box format in predictions is center x, y and width, height
      // Convert to top-left (x1, y1) and bottom-right (x2, y2)
      const boxA_x1 = boxA.x - (boxA.width / 2);
      const boxA_y1 = boxA.y - (boxA.height / 2);
      const boxA_x2 = boxA.x + (boxA.width / 2);
      const boxA_y2 = boxA.y + (boxA.height / 2);

      const boxB_x1 = boxB.x - (boxB.width / 2);
      const boxB_y1 = boxB.y - (boxB.height / 2);
      const boxB_x2 = boxB.x + (boxB.width / 2);
      const boxB_y2 = boxB.y + (boxB.height / 2);

      // Determine the coordinates of the intersection rectangle
      const xA = Math.max(boxA_x1, boxB_x1);
      const yA = Math.max(boxA_y1, boxB_y1);
      const xB = Math.min(boxA_x2, boxB_x2);
      const yB = Math.min(boxA_y2, boxB_y2);

      // Compute the area of intersection
      const interWidth = Math.max(0, xB - xA);
      const interHeight = Math.max(0, yB - yA);
      const interArea = interWidth * interHeight;

      // Compute the area of both rectangles
      const boxAArea = boxA.width * boxA.height;
      const boxBArea = boxB.width * boxB.height;

      // Compute the intersection over union
      const iou = interArea / (boxAArea + boxBArea - interArea);
      return iou;
    }

    // Non-Maximum Suppression (NMS)
    function applyNMS(predictions, iouThreshold) {
      if (!predictions || predictions.length === 0) return [];

      // Sort by confidence descending
      predictions.sort((a, b) => b.confidence - a.confidence);

      const keep = [];
      const flags = new Array(predictions.length).fill(true);

      for (let i = 0; i < predictions.length; i++) {
        if (!flags[i]) continue;

        keep.push(predictions[i]);

        for (let j = i + 1; j < predictions.length; j++) {
          if (!flags[j]) continue;

          if (calculateIoU(predictions[i], predictions[j]) > iouThreshold) {
            flags[j] = false;
          }
        }
      }
      return keep;
    }

    function processAutoDetect() {
      const streamImg = document.getElementById('cameraStream');
      const canvas = document.getElementById('captureCanvas');
      const overlayCanvas = document.getElementById('overlayCanvas');
      
      // Controls
      const confSlider = document.getElementById('confThreshold');
      const overlapSlider = document.getElementById('overlapThreshold');
      const opacitySlider = document.getElementById('opacityThreshold');
      const labelModeSelect = document.getElementById('labelMode');
      const jsonOutput = document.getElementById('jsonOutput');
      
      const confThreshold = confSlider ? parseInt(confSlider.value) / 100 : 0.3;
      const overlapThreshold = overlapSlider ? parseInt(overlapSlider.value) / 100 : 0.5;
      const opacityThreshold = opacitySlider ? parseInt(opacitySlider.value) / 100 : 0.75;
      const labelMode = labelModeSelect ? labelModeSelect.value : 'conf';
      
      if (!streamImg || !streamImg.src || streamImg.style.display === 'none') return;
      
      try {
        canvas.width = streamImg.naturalWidth || 640;
        canvas.height = streamImg.naturalHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(streamImg, 0, 0, canvas.width, canvas.height);
        
        // Setup overlay canvas to match stream dimensions
        if (overlayCanvas) {
            overlayCanvas.width = canvas.width;
            overlayCanvas.height = canvas.height;
            const ctxOverlay = overlayCanvas.getContext('2d');
            ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        }
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
        
        const statusDiv = document.getElementById('streamStatus');
        
        fetch('/api/detect_live', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: dataURL })
        })
        .then(res => res.json())
        .then(data => {
            // Update JSON Output
            if (jsonOutput && data.result) {
                if (data.result.predictions) {
                    jsonOutput.textContent = JSON.stringify({ predictions: data.result.predictions }, null, 2);
                } else if (data.result.condition === 'Not Pechay') {
                     jsonOutput.textContent = JSON.stringify({ 
                         condition: 'Not Pechay',
                         reason: data.result.recommendations ? data.result.recommendations.tips : 'Validation failed'
                     }, null, 2);
                }
            }
            
            // Show status if blocked
            if (data.result && data.result.condition === 'Not Pechay') {
                 if (statusDiv) {
                     // Get the specific reason if available
                     let reason = 'Not a Pechay Leaf';
                     if (data.result.recommendations && data.result.recommendations.tips && data.result.recommendations.tips.length > 0) {
                         reason = data.result.recommendations.tips[0];
                     }
                     statusDiv.textContent = '‚õî Blocked: ' + reason;
                     statusDiv.className = 'stream-status error';
                 }
                 // Clear overlay if blocked
                 if (overlayCanvas) {
                     const ctxOverlay = overlayCanvas.getContext('2d');
                     ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                 }
                 return; // Stop processing predictions
            } else if (statusDiv && statusDiv.textContent.includes('‚õî')) {
                 statusDiv.textContent = 'ü§ñ Auto-Detection Active - Scanning...';
                 statusDiv.className = 'stream-status connected';
            }

            // Draw Bounding Boxes if overlay canvas exists
            if (overlayCanvas && data.result && data.result.predictions) {
                const ctxOverlay = overlayCanvas.getContext('2d');
                ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height); // Clear previous
                
                // Filter by confidence first
                let predictions = data.result.predictions.filter(p => p.confidence >= confThreshold);
                
                // Apply NMS (Overlap Threshold)
                predictions = applyNMS(predictions, overlapThreshold);
                
                predictions.forEach(pred => {
                    const x = pred.x - (pred.width / 2); // Center x to top-left x
                    const y = pred.y - (pred.height / 2); // Center y to top-left y
                    const width = pred.width;
                    const height = pred.height;
                    const label = pred.class;
                    const confidence = (pred.confidence * 100).toFixed(1);
                    
                    // Determine color based on class
                    let color = '#00FF00'; // Default green
                    if (label.toLowerCase().includes('healthy')) {
                        color = '#00FF00'; // Green
                    } else if (label.toLowerCase().includes('disease') || label.toLowerCase().includes('rot') || label.toLowerCase().includes('spot')) {
                        color = '#FF0000'; // Red
                    }
                    
                    // Draw Box
                    ctxOverlay.beginPath();
                    ctxOverlay.lineWidth = 4;
                    ctxOverlay.strokeStyle = color;
                    ctxOverlay.globalAlpha = opacityThreshold;
                    ctxOverlay.rect(x, y, width, height);
                    ctxOverlay.stroke();
                    ctxOverlay.globalAlpha = 1.0; // Reset alpha
                    
                    if (labelMode !== 'none') {
                        // Draw Background for Label
                        ctxOverlay.fillStyle = color;
                        let text = label;
                        if (labelMode === 'conf') {
                            text += ` ${confidence}%`;
                        }
                        
                        const font = "bold 18px Arial";
                        ctxOverlay.font = font;
                        const textWidth = ctxOverlay.measureText(text).width;
                        const textHeight = 25;
                        
                        // Ensure label doesn't go off top
                        let labelY = y - textHeight;
                        if (labelY < 0) labelY = y;
                        
                        ctxOverlay.globalAlpha = opacityThreshold;
                        ctxOverlay.fillRect(x, labelY, textWidth + 10, textHeight);
                        ctxOverlay.globalAlpha = 1.0;
                        
                        // Draw Label Text
                        ctxOverlay.fillStyle = "#FFFFFF";
                        ctxOverlay.fillText(text, x + 5, labelY + 18);
                    }
                });
            }

            if (data.saved) {
                console.log('Auto-detected and saved:', data.result);
                if (statusDiv) {
                    statusDiv.innerHTML = `‚úÖ <strong>Saved:</strong> ${data.result.condition} (${(data.result.confidence).toFixed(1)}%)`;
                    // Visual feedback
                    statusDiv.className = 'stream-status connected';
                    statusDiv.style.background = '#d1e7dd';
                    setTimeout(() => {
                        if (autoDetectInterval) {
                           // Keep the status text but reset background
                           statusDiv.style.background = '';
                        }
                    }, 2000);
                }
            } else if (data.result) {
                 if (statusDiv) {
                    // Just show status if not saved
                    statusDiv.innerHTML = `Scanning... Last: ${data.result.condition} (${(data.result.confidence || 0).toFixed(1)}%)`;
                }
            }
        })
        .catch(err => console.error('Auto-detect error:', err));
        
      } catch (e) {
        console.error('Auto-detect canvas error:', e);
      }
    }

    function startPolling() {
      console.log('startPolling() called');
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) {
        alert('Camera IP input not found!');
        return;
      }
      // Clean up IP input
      let ipValue = cameraIP.value.trim();
      ipValue = ipValue.replace(/^https?:\/\//, '').replace(/\/+$/, '');
      
      const statusDiv = document.getElementById('streamStatus');
      const streamImg = document.getElementById('cameraStream');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      stopStream();
      if (placeholder) placeholder.style.display = 'none';
      
      const captureUrl = 'http://' + ipValue + '/capture';
      streamImg.style.display = 'block';
      streamImg.style.width = '100%';
      streamImg.style.height = 'auto';
      // Enable CORS
      streamImg.crossOrigin = 'anonymous';
      cameraStreamImg = streamImg;
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Polling camera at ' + ipValue + '...';
      }
      if (captureBtn) captureBtn.disabled = false;
      
      streamInterval = setInterval(function() {
        const timestamp = new Date().getTime();
        streamImg.src = captureUrl + '?t=' + timestamp;
      }, 500);
      
      const timestamp = new Date().getTime();
      streamImg.src = captureUrl + '?t=' + timestamp;
      
      streamImg.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Polling active - Camera connected!';
        }
      };
      
      streamImg.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Failed to connect. Check IP address and ensure ESP32-CAM is running.';
        }
        console.error('Polling error for:', captureUrl);
        stopStream();
      };
    }
    
    function stopStream() {
      const streamImg = document.getElementById('cameraStream');
      const streamFrame = document.getElementById('cameraStreamFrame');
      const statusDiv = document.getElementById('streamStatus');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      const overlayCanvas = document.getElementById('overlayCanvas');
      
      if (streamInterval) {
        clearInterval(streamInterval);
        streamInterval = null;
      }
      if (autoDetectInterval) {
        clearInterval(autoDetectInterval);
        autoDetectInterval = null;
      }
      
      if (streamImg) {
        streamImg.src = '';
        streamImg.style.display = 'none';
      }
      if (streamFrame) {
        streamFrame.src = '';
        streamFrame.style.display = 'none';
      }
      if (overlayCanvas) {
        overlayCanvas.style.display = 'none';
      }
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Stream stopped';
      }
      if (captureBtn) captureBtn.disabled = true;
      cameraStreamImg = null;
      if (placeholder) placeholder.style.display = 'block';
    }
    
    function testConnection() {
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) return;
      
      // Clean up IP input
      let ipValue = cameraIP.value.trim();
      ipValue = ipValue.replace(/^https?:\/\//, '').replace(/\/+$/, '');
      
      const statusDiv = document.getElementById('streamStatus');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Testing connection to ' + ipValue + '...';
      }
      
      const testUrl = 'http://' + ipValue + '/capture';
      const img = new Image();
      // Enable CORS for consistency
      img.crossOrigin = 'anonymous';
      
      img.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Camera is reachable! You can now start the stream.';
        }
      };
      
      img.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Cannot reach camera at ' + ipValue + '. Check:\n- ESP32-CAM is powered on\n- Both devices are on same network\n- IP address is correct';
        }
        console.error('Connection test failed for:', testUrl);
      };
      
      const timestamp = new Date().getTime();
      img.src = testUrl + '?t=' + timestamp;
    }
    
    function captureFromStream() {
      const streamImg = document.getElementById('cameraStream');
      const canvas = document.getElementById('captureCanvas');
      const statusDiv = document.getElementById('streamStatus');
      
      if (!streamImg || !streamImg.src || streamImg.style.display === 'none') {
        alert('Please start the camera stream first');
        return;
      }
      
      try {
        canvas.width = streamImg.naturalWidth || streamImg.width || 640;
        canvas.height = streamImg.naturalHeight || streamImg.height || 480;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(streamImg, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob(function(blob) {
          const formData = new FormData();
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          formData.append('leafImage', blob, 'esp32_capture_' + timestamp + '.jpg');
          
          if (statusDiv) {
            statusDiv.className = 'stream-status';
            statusDiv.textContent = 'Uploading captured image...';
          }
          
          fetch(window.location.href, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (response.ok) {
              if (statusDiv) {
                statusDiv.className = 'stream-status connected';
                statusDiv.textContent = '‚úì Image captured and uploaded successfully!';
              }
              setTimeout(function() {
                window.location.reload();
              }, 1500);
            } else {
              throw new Error('Upload failed');
            }
          })
          .catch(error => {
            if (statusDiv) {
              statusDiv.className = 'stream-status error';
              statusDiv.textContent = '‚úó Failed to upload image: ' + error.message;
            }
          });
        }, 'image/jpeg', 0.95);
      } catch (error) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Capture failed: ' + error.message;
        }
        console.error('Capture error:', error);
      }
    }
    
    window.addEventListener('beforeunload', function() {
      stopStream();
    });
  </script>


</body>
</html>
